<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nexus-G: High-Visibility Compact</title>
    <style>
        body { margin: 0; background-color: #000; color: #0f0; font-family: 'Consolas', 'Monaco', monospace; overflow: hidden; font-size: 11px; }
        .container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        #input_video { display: none; }
        #output_canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }

        /* --- COMPACT PANELS --- */
        .panel {
            position: absolute;
            background: rgba(0, 5, 8, 0.92);
            border: 1px solid rgba(0, 255, 68, 0.3);
            padding: 4px; /* Tighter padding */
            width: 190px; /* Slight increase to fit larger font */
            pointer-events: none;
            backdrop-filter: blur(3px);
            display: flex;
            flex-direction: column;
            gap: 1px; /* Minimal gap */
        }

        .panel h3 { 
            margin: 0 0 3px 0; padding-bottom: 2px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2); 
            font-size: 12px; font-weight: 800; color: #fff; letter-spacing: 0.5px;
        }

        /* Compact Rows */
        .row { display: flex; justify-content: space-between; align-items: center; line-height: 13px; }
        .lbl { color: #999; font-size: 10px; font-weight: 600; white-space: nowrap; }
        .val { color: #fff; font-weight: bold; font-size: 11px; }
        
        /* Sub-groups tightly packed */
        .sub-group { border-top: 1px dashed #333; margin-top: 2px; padding-top: 2px; }

        /* Micro Bars */
        .bar-bg { width: 100%; height: 3px; background: #111; margin-top: 1px; border: 1px solid #333; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.1s; }
        
        /* Dense Grids */
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; row-gap: 1px; }
        .grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 4px; row-gap: 1px; }

        /* Colors */
        .c-grn { color: #00ff44; } .fill-grn { background: #00ff44; }
        .c-cyn { color: #00ddee; } .fill-cyn { background: #00ddee; }
        .c-org { color: #ffaa00; } .fill-org { background: #ffaa00; }
        .c-mag { color: #ff00ff; } .fill-mag { background: #ff00ff; }

        /* Positions */
        #pnl-left { top: 10px; left: 10px; border-left: 3px solid #00ff44; }
        #pnl-right { top: 10px; right: 10px; border-right: 3px solid #00ff44; }
        #pnl-spatial { bottom: 10px; left: 10px; border-left: 3px solid #00ddee; width: 180px; }
        #pnl-expression { bottom: 10px; right: 10px; border-right: 3px solid #ffaa00; width: 160px; text-align: right; }
        #pnl-expression .row { flex-direction: row-reverse; }

        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #00ff44; font-size: 14px; font-weight:bold; }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="container">
    <div id="loading">SYSTEM BOOT...</div>
    <video id="input_video"></video>
    <canvas id="output_canvas"></canvas>

    <div id="pnl-left" class="panel">
        <h3 class="c-grn">LEFT HAND</h3>
        <div id="lh-content">Waiting...</div>
    </div>

    <div id="pnl-right" class="panel">
        <h3 class="c-grn">RIGHT HAND</h3>
        <div id="rh-content">Waiting...</div>
    </div>

    <div id="pnl-spatial" class="panel">
        <h3 class="c-cyn">SPATIAL TRACK</h3>
        <div class="row"><span class="lbl">FACE XYZ</span><span id="face-pos" class="val">--</span></div>
        
        <div class="sub-group">
            <div class="row"><span class="lbl c-mag">HAND ↔ HAND</span><span id="dist-lr" class="val">--</span></div>
            <div class="bar-bg"><div id="bar-lr" class="bar-fill fill-mag"></div></div>
            <div class="row"><span class="lbl c-mag">IDX ↔ IDX</span><span id="dist-ii" class="val">--</span></div>
            <div class="bar-bg"><div id="bar-ii" class="bar-fill fill-mag"></div></div>
        </div>
        
        <div class="sub-group">
            <div class="row"><span class="lbl">FACE ↔ LH</span><span id="dist-fl" class="val">--</span></div>
            <div class="row"><span class="lbl">FACE ↔ RH</span><span id="dist-fr" class="val">--</span></div>
        </div>
    </div>

    <div id="pnl-expression" class="panel">
        <h3 class="c-org">FACE STATE</h3>
        <div class="row"><span class="lbl">PITCH</span><span id="face-pitch" class="val">0</span></div>
        <div class="row"><span class="lbl">YAW</span><span id="face-yaw" class="val">0</span></div>
        <div class="row"><span class="lbl">ROLL</span><span id="face-roll" class="val">0°</span></div>
        <div class="sub-group">
            <div class="row"><span class="lbl">L.EYE</span><span id="eye-l" class="val">--</span></div>
            <div class="row"><span class="lbl">R.EYE</span><span id="eye-r" class="val">--</span></div>
            <div class="row"><span class="lbl">MOUTH</span><span id="mouth-val" class="val">0%</span></div>
            <div class="bar-bg"><div id="bar-mouth" class="bar-fill fill-org"></div></div>
        </div>
    </div>
</div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    
    let globalCoords = { lHand: null, rHand: null, lIndex: null, rIndex: null, face: null };

    // --- HTML GENERATOR ---
    function generateHandHTML(data) {
        if(!data.active) return `<div style="color:#555; padding:2px 0; font-size:10px;">NO SIGNAL</div>`;
        
        const bar = (val, max) => `<div class="bar-bg"><div class="bar-fill fill-grn" style="width:${Math.min(100, (val/max)*100)}%"></div></div>`;
        
        return `
            <div class="row"><span class="lbl">POS X/Y</span><span class="val">${data.x}/${data.y}</span></div>
            <div class="row"><span class="lbl">Z / TILT</span><span class="val">${data.dist}cm / ${data.tilt}°</span></div>

            <div class="sub-group">
                <div class="row" style="color:#00ff44; font-size:10px; font-weight:bold;">THUMB TO TIP</div>
                <div class="grid-4">
                    <div><span class="lbl">ID</span> <span class="val">${data.dTi}</span>${bar(15-data.dTi, 15)}</div>
                    <div><span class="lbl">MI</span> <span class="val">${data.dTm}</span>${bar(15-data.dTm, 15)}</div>
                    <div><span class="lbl">RG</span> <span class="val">${data.dTr}</span>${bar(15-data.dTr, 15)}</div>
                    <div><span class="lbl">PK</span> <span class="val">${data.dTp}</span>${bar(15-data.dTp, 15)}</div>
                </div>
            </div>

            <div class="sub-group">
                <div class="grid-3">
                  <div class="row" style="color:#00ff44; font-size:10px; font-weight:bold;">PALM RANGE</div>
                  <div></div>
                  <div>
                  <div class="row"><span class="lbl c-cyn" style="font-weight:bold;">THUMB</span> <span class="val">${data.pTt}</span></div>
                  ${bar(data.pTt, 15)}
                  </div>
                </div>
                
                <div class="grid-4" style="margin-top:2px;">
                    <div><span class="lbl">ID</span> <span class="val">${data.pTi}</span>${bar(data.pTi, 20)}</div>
                    <div><span class="lbl">MI</span> <span class="val">${data.pTm}</span>${bar(data.pTm, 20)}</div>
                    <div><span class="lbl">RG</span> <span class="val">${data.pTr}</span>${bar(data.pTr, 20)}</div>
                    <div><span class="lbl">PK</span> <span class="val">${data.pTp}</span>${bar(data.pTp, 20)}</div>
                </div>
            </div>
        `;
    }

    // --- MATH ---
    function dist(p1, p2) { return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)); }
    function estimateDepth(pixelDist, realCm) { return pixelDist > 0 ? Math.round((0.65 * realCm) / pixelDist) : 0; }

    // --- PROCESSORS ---
    function processHand(landmarks) {
        if(!landmarks) return { active: false };
        
        let cx = landmarks[0].x, cy = landmarks[0].y;
        let dPx = dist(landmarks[0], landmarks[17]);
        let pxPerCm = dPx / 8.0;

        // Thumb to Fingers
        let dTi = (dist(landmarks[4], landmarks[8]) / pxPerCm).toFixed(1);
        let dTm = (dist(landmarks[4], landmarks[12]) / pxPerCm).toFixed(1);
        let dTr = (dist(landmarks[4], landmarks[16]) / pxPerCm).toFixed(1);
        let dTp = (dist(landmarks[4], landmarks[20]) / pxPerCm).toFixed(1);

        // Palm (Wrist) to Tips
        let pTt = (dist(landmarks[0], landmarks[4]) / pxPerCm).toFixed(1); 
        let pTi = (dist(landmarks[0], landmarks[8]) / pxPerCm).toFixed(1);
        let pTm = (dist(landmarks[0], landmarks[12]) / pxPerCm).toFixed(1);
        let pTr = (dist(landmarks[0], landmarks[16]) / pxPerCm).toFixed(1);
        let pTp = (dist(landmarks[0], landmarks[20]) / pxPerCm).toFixed(1);

        let tilt = Math.round((Math.atan2(landmarks[9].y - landmarks[0].y, landmarks[9].x - landmarks[0].x) * 180 / Math.PI) + 90);

        return { 
            active: true, x: cx.toFixed(2), y: cy.toFixed(2), 
            dist: estimateDepth(dPx, 8.0), tilt,
            dTi, dTm, dTr, dTp, 
            pTt, pTi, pTm, pTr, pTp, 
            rawCenter: {x:cx, y:cy}, rawIndex: landmarks[8] 
        };
    }

    function processFace(landmarks) {
        if(!landmarks) return null;
        let nose = landmarks[1];
        let dZ = estimateDepth(dist(landmarks[234], landmarks[454]), 15);
        document.getElementById('face-pos').innerText = `${nose.x.toFixed(2)}/${nose.y.toFixed(2)} Z:${dZ}`;

        let midFace = (landmarks[234].x + landmarks[454].x) / 2;
        let faceH = dist(landmarks[10], landmarks[152]);
        
        document.getElementById('face-yaw').innerText = Math.round((nose.x - midFace) * 1000);
        document.getElementById('face-pitch').innerText = Math.round(((nose.y - landmarks[10].y)/faceH - 0.5) * 100);
        document.getElementById('face-roll').innerText = Math.round(Math.atan2(landmarks[454].y - landmarks[234].y, landmarks[454].x - landmarks[234].x) * 180/Math.PI) + "°";

        let mPct = Math.round(Math.min(100, Math.max(0, ((dist(landmarks[13], landmarks[14])/faceH)*100 - 2) * 8)));
        document.getElementById('mouth-val').innerText = mPct + "%";
        document.getElementById('bar-mouth').style.width = mPct + "%";

        let lOpen = (dist(landmarks[159], landmarks[145]) / faceH) * 100 > 2.0;
        let rOpen = (dist(landmarks[386], landmarks[374]) / faceH) * 100 > 2.0;
        
        let elL = document.getElementById('eye-l'), elR = document.getElementById('eye-r');
        elL.innerText = lOpen ? "OPEN" : "BLINK"; elL.style.color = lOpen ? "#fff" : "#f33";
        elR.innerText = rOpen ? "OPEN" : "BLINK"; elR.style.color = rOpen ? "#fff" : "#f33";

        return { x: nose.x, y: nose.y };
    }

    // --- MAIN LOOP ---
    function onResults(results) {
        document.getElementById('loading').style.display = 'none';
        canvasCtx.save();
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        globalCoords = { lHand: null, rHand: null, lIndex: null, rIndex: null, face: null };
        globalCoords.face = processFace(results.faceLandmarks);

        let ld = processHand(results.leftHandLandmarks);
        document.getElementById('lh-content').innerHTML = generateHandHTML(ld);
        if(ld.active) { globalCoords.lHand = ld.rawCenter; globalCoords.lIndex = ld.rawIndex; }

        let rd = processHand(results.rightHandLandmarks);
        document.getElementById('rh-content').innerHTML = generateHandHTML(rd);
        if(rd.active) { globalCoords.rHand = rd.rawCenter; globalCoords.rIndex = rd.rawIndex; }

        // Triangulation
        const draw = (p1, p2, idT, idB, col='rgba(255,0,255,0.4)') => {
            canvasCtx.strokeStyle = col; canvasCtx.beginPath(); 
            canvasCtx.moveTo(p1.x*1280, p1.y*720); canvasCtx.lineTo(p2.x*1280, p2.y*720); canvasCtx.stroke();
            let d = Math.round(dist(p1, p2)*100);
            if(idT) document.getElementById(idT).innerText = d;
            if(idB) document.getElementById(idB).style.width = Math.min(100, d) + "%";
        };

        if(globalCoords.lHand && globalCoords.rHand) draw(globalCoords.lHand, globalCoords.rHand, 'dist-lr', 'bar-lr');
        if(globalCoords.lIndex && globalCoords.rIndex) draw(globalCoords.lIndex, globalCoords.rIndex, 'dist-ii', 'bar-ii', 'rgba(0,255,255,0.5)');
        if(globalCoords.face) {
            if(globalCoords.lHand) draw(globalCoords.face, globalCoords.lHand, 'dist-fl', null, 'rgba(0,221,238,0.2)');
            if(globalCoords.rHand) draw(globalCoords.face, globalCoords.rHand, 'dist-fr', null, 'rgba(0,221,238,0.2)');
        }
        
        canvasCtx.restore();
    }

    const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
    holistic.setOptions({ modelComplexity: 1, smoothLandmarks: true, refineFaceLandmarks: true });
    holistic.onResults(onResults);

    const camera = new Camera(videoElement, { onFrame: async () => await holistic.send({image: videoElement}), width: 1280, height: 720 });
    canvasElement.width = 1280; canvasElement.height = 720;
    camera.start();
</script>
</body>
</html>